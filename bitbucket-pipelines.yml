image: johngrimes/node-now
pipelines:
  default:
    - step:
        name: Run tests
        caches:
          - node
        script:
          - yarn
          - yarn test-ci
  branches:
    master:
      - step:
          name: Run tests and deploy
          caches:
            - node
          script:
            - yarn
            - yarn test-ci
            - >
              echo "{ \"fhirServer\": \"$FHIR_SERVER\" }" > public/config.json
            - yarn build
            - yarn build-docker
            - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
            - docker push johngrimes/polecat
            - cp -R build release
            - >
              find release -name "*.map" -exec rm {} \;
            - now -n polecat -t $NOW_TOKEN alias set `now -n polecat -t $NOW_TOKEN release` $TARGET_HOSTNAME
            - yarn run sentry-cli releases -p $SENTRY_PROJECT new `git rev-parse HEAD` && yarn run sentry-cli releases -p $SENTRY_PROJECT files `git rev-parse HEAD` upload-sourcemaps --url-prefix https://$TARGET_HOSTNAME/static/js build/static/js
options:
  docker: true
